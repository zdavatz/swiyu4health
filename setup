#!/usr/bin/env bash
# =============================================================================
# swiyu Generic Issuer & Verifier – Setup-Script für Debian/Ubuntu
# =============================================================================
# Version: 2.0
# Getestet: Februar 2026, swiyu-int (Integration-Umgebung)
#
# Voraussetzungen (müssen VOR diesem Script erfüllt sein):
#   1. Registrierung im swiyu Trust Infrastructure Portal (ePortal)
#   2. Registrierung im API Self-Service Portal (selfservice.api.admin.ch)
#   3. Java 21+ installiert (für didtoolbox)
#   4. DID erstellt und im Identifier Registry publiziert (siehe README)
#
# Dokumentation: https://swiyu-admin-ch.github.io/cookbooks/
# =============================================================================
set -euo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# .ENV AUTOMATISCH LADEN
# ─────────────────────────────────────────────────────────────────────────────
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="${SCRIPT_DIR}/.env"

if [[ -f "${ENV_FILE}" ]]; then
    echo "[INFO]  Lade Konfiguration aus ${ENV_FILE}..."
    set -a
    while IFS= read -r line || [[ -n "${line}" ]]; do
        [[ "${line}" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line// }" ]] && continue
        export "${line?}"
    done < "${ENV_FILE}"
    set +a
    echo "[OK]    .env geladen."
else
    echo "[WARN]  Keine .env Datei gefunden unter ${ENV_FILE}"
    echo "        Bitte erstellen: vim ${ENV_FILE}"
    echo "        Vorlage: swiyu-setup.env.example"
fi

# ─────────────────────────────────────────────────────────────────────────────
# FARBEN & HELPER
# ─────────────────────────────────────────────────────────────────────────────
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'
info()    { echo -e "${CYAN}[INFO]${NC}  $*"; }
success() { echo -e "${GREEN}[OK]${NC}    $*"; }
warn()    { echo -e "${YELLOW}[WARN]${NC}  $*"; }
error()   { echo -e "${RED}[ERROR]${NC} $*" >&2; exit 1; }

SETUP_DIR="${SWIYU_SETUP_DIR:-/opt/swiyu}"

# ─────────────────────────────────────────────────────────────────────────────
# 1. KONFIGURATIONSVARIABLEN
# ─────────────────────────────────────────────────────────────────────────────

# ── Allgemein ──────────────────────────────────────────────────────────────
: "${EXTERNAL_DOMAIN:?Bitte EXTERNAL_DOMAIN setzen, z.B. swiyu.example.ch}"
ISSUER_EXTERNAL_URL="${ISSUER_EXTERNAL_URL:-https://${EXTERNAL_DOMAIN}/issuer}"
VERIFIER_EXTERNAL_URL="${VERIFIER_EXTERNAL_URL:-https://${EXTERNAL_DOMAIN}/verifier}"

# ── Issuer-Schlüssel & DID ─────────────────────────────────────────────────
: "${ISSUER_DID:?Bitte ISSUER_DID setzen (did:tdw:...)}"
: "${ISSUER_DID_VERIFICATION_METHOD:?Bitte ISSUER_DID_VERIFICATION_METHOD setzen}"
: "${ISSUER_SIGNING_KEY:?Bitte ISSUER_SIGNING_KEY setzen (PEM-kodierter EC privater Schlüssel)}"
: "${STATUS_LIST_SIGNING_KEY:?Bitte STATUS_LIST_SIGNING_KEY setzen}"
: "${STATUS_LIST_VERIFICATION_METHOD:?Bitte STATUS_LIST_VERIFICATION_METHOD setzen}"

# ── Verifier-Schlüssel & DID ───────────────────────────────────────────────
: "${VERIFIER_DID:?Bitte VERIFIER_DID setzen (did:tdw:...)}"
: "${VERIFIER_DID_VERIFICATION_METHOD:?Bitte VERIFIER_DID_VERIFICATION_METHOD setzen}"
: "${VERIFIER_SIGNING_KEY:?Bitte VERIFIER_SIGNING_KEY setzen}"

# ── swiyu API-Credentials (aus dem API Self-Service Portal) ────────────────
: "${SWIYU_PARTNER_ID:?Bitte SWIYU_PARTNER_ID setzen}"

# WICHTIG: Korrekte URLs laut offizieller Dokumentation (Stand Feb 2026):
#   Status Registry API:  https://status-reg-api.trust-infra.swiyu-int.admin.ch
#   Token URL:            https://keymanager-prd.api.admin.ch/keycloak/realms/APIGW/protocol/openid-connect/token
SWIYU_STATUS_REGISTRY_API_URL="${SWIYU_STATUS_REGISTRY_API_URL:-https://status-reg-api.trust-infra.swiyu-int.admin.ch}"
SWIYU_STATUS_REGISTRY_TOKEN_URL="${SWIYU_STATUS_REGISTRY_TOKEN_URL:-https://keymanager-prd.api.admin.ch/keycloak/realms/APIGW/protocol/openid-connect/token}"
: "${SWIYU_STATUS_REGISTRY_CUSTOMER_KEY:?Bitte SWIYU_STATUS_REGISTRY_CUSTOMER_KEY setzen}"
: "${SWIYU_STATUS_REGISTRY_CUSTOMER_SECRET:?Bitte SWIYU_STATUS_REGISTRY_CUSTOMER_SECRET setzen}"
: "${SWIYU_STATUS_REGISTRY_BOOTSTRAP_REFRESH_TOKEN:?Bitte SWIYU_STATUS_REGISTRY_BOOTSTRAP_REFRESH_TOKEN setzen}"

# ── Datenbank-Passwörter ───────────────────────────────────────────────────
ISSUER_DB_PASSWORD="${ISSUER_DB_PASSWORD:-$(openssl rand -hex 24)}"
VERIFIER_DB_PASSWORD="${VERIFIER_DB_PASSWORD:-$(openssl rand -hex 24)}"

# ── Docker-Image-Tags ──────────────────────────────────────────────────────
ISSUER_IMAGE_TAG="${ISSUER_IMAGE_TAG:-stable}"
VERIFIER_IMAGE_TAG="${VERIFIER_IMAGE_TAG:-stable}"

# ── Credential-Typ ─────────────────────────────────────────────────────────
CREDENTIAL_TYPE="${CREDENTIAL_TYPE:-doctor-credential}"
CREDENTIAL_VCT="${CREDENTIAL_VCT:-doctor-credential-sdjwt}"
CREDENTIAL_NAME_DE="${CREDENTIAL_NAME_DE:-Arztausweis}"
CREDENTIAL_NAME_FR="${CREDENTIAL_NAME_FR:-Carte de médecin}"
CREDENTIAL_NAME_EN="${CREDENTIAL_NAME_EN:-Doctor Credential}"

# ─────────────────────────────────────────────────────────────────────────────
# 2. ABHÄNGIGKEITEN INSTALLIEREN
# ─────────────────────────────────────────────────────────────────────────────
install_dependencies() {
    info "Prüfe und installiere Abhängigkeiten..."
    apt-get update -qq

    # Docker
    if ! command -v docker &>/dev/null; then
        info "Installiere Docker..."
        apt-get install -y -qq ca-certificates curl gnupg lsb-release
        install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/debian/gpg \
            | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
        echo "deb [arch=$(dpkg --print-architecture) \
signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/debian \
$(lsb_release -cs) stable" \
            | tee /etc/apt/sources.list.d/docker.list > /dev/null
        apt-get update -qq
        apt-get install -y -qq docker-ce docker-ce-cli containerd.io docker-compose-plugin
        systemctl enable --now docker
        success "Docker installiert."
    else
        success "Docker bereits vorhanden: $(docker --version)"
    fi

    if ! docker compose version &>/dev/null; then
        error "Docker Compose Plugin nicht gefunden. Bitte Docker neu installieren."
    fi

    # Java 21 (für didtoolbox)
    if ! command -v java &>/dev/null; then
        info "Installiere OpenJDK 21 (für didtoolbox)..."
        apt-get install -y -qq openjdk-21-jre-headless
        success "Java installiert."
    else
        success "Java bereits vorhanden: $(java -version 2>&1 | head -1)"
    fi

    # Apache + Certbot
    if ! command -v apache2 &>/dev/null; then
        info "Installiere Apache..."
        apt-get install -y -qq apache2
        success "Apache installiert."
    else
        success "Apache bereits vorhanden."
    fi
    a2enmod proxy proxy_http ssl headers rewrite -q || true

    if ! command -v certbot &>/dev/null; then
        info "Installiere Certbot..."
        apt-get install -y -qq certbot python3-certbot-apache
        success "Certbot installiert."
    else
        success "Certbot bereits vorhanden."
    fi

    # Weitere Tools
    apt-get install -y -qq curl jq openssl qrencode
    success "Alle Abhängigkeiten installiert."
}

# ─────────────────────────────────────────────────────────────────────────────
# 3. VERZEICHNISSTRUKTUR
# ─────────────────────────────────────────────────────────────────────────────
create_directories() {
    info "Erstelle Verzeichnisstruktur unter ${SETUP_DIR}..."
    mkdir -p \
        "${SETUP_DIR}/issuer/config" \
        "${SETUP_DIR}/issuer/data" \
        "${SETUP_DIR}/verifier/config" \
        "${SETUP_DIR}/verifier/data"
    chmod 750 "${SETUP_DIR}/issuer" "${SETUP_DIR}/verifier"
    success "Verzeichnisse erstellt."
}

# ─────────────────────────────────────────────────────────────────────────────
# 4. ISSUER-METADATEN
# ─────────────────────────────────────────────────────────────────────────────
write_issuer_metadata() {
    info "Schreibe Issuer-Metadaten..."
    # WICHTIG:
    #   - version "1.0" ist Pflicht
    #   - Schlüssel heisst credential_configurations_supported (nicht credentials_supported)
    #   - claims mit sd: "always" für Selective Disclosure
    cat > "${SETUP_DIR}/issuer/config/issuer_metadata.json" <<EOF
{
  "version": "1.0",
  "credential_issuer": "${ISSUER_EXTERNAL_URL}",
  "credential_endpoint": "${ISSUER_EXTERNAL_URL}/oid4vci/api/credential",
  "nonce_endpoint": "${ISSUER_EXTERNAL_URL}/oid4vci/api/nonce",
  "credential_configurations_supported": {
    "${CREDENTIAL_TYPE}": {
      "format": "vc+sd-jwt",
      "vct": "${CREDENTIAL_VCT}",
      "credential_signing_alg_values_supported": ["ES256"],
      "claims": {
        "firstName": {
          "display": [
            {"name": "Vorname", "locale": "de-CH"},
            {"name": "Prénom", "locale": "fr-CH"},
            {"name": "Nome", "locale": "it-CH"},
            {"name": "First name", "locale": "en"}
          ],
          "sd": "always"
        },
        "lastName": {
          "display": [
            {"name": "Nachname", "locale": "de-CH"},
            {"name": "Nom de famille", "locale": "fr-CH"},
            {"name": "Cognome", "locale": "it-CH"},
            {"name": "Last name", "locale": "en"}
          ],
          "sd": "always"
        },
        "gln": {
          "display": [
            {"name": "GLN", "locale": "de-CH"},
            {"name": "GLN", "locale": "fr-CH"},
            {"name": "GLN", "locale": "it-CH"},
            {"name": "GLN", "locale": "en"}
          ],
          "sd": "always"
        }
      },
      "order": ["firstName", "lastName", "gln"],
      "display": [
        {
          "name": "${CREDENTIAL_NAME_DE}",
          "locale": "de-CH",
          "background_color": "#003d73",
          "text_color": "#ffffff",
          "logo": {
            "uri": "https://${EXTERNAL_DOMAIN}/logo.png",
            "alt_text": "${CREDENTIAL_NAME_EN} Logo"
          }
        },
        {
          "name": "${CREDENTIAL_NAME_FR}",
          "locale": "fr-CH",
          "background_color": "#003d73",
          "text_color": "#ffffff"
        },
        {
          "name": "${CREDENTIAL_NAME_EN}",
          "locale": "en",
          "background_color": "#003d73",
          "text_color": "#ffffff"
        }
      ]
    }
  }
}
EOF
    success "Issuer-Metadaten geschrieben."
}

# ─────────────────────────────────────────────────────────────────────────────
# 5. VERIFIER-METADATEN
# ─────────────────────────────────────────────────────────────────────────────
write_verifier_metadata() {
    info "Schreibe Verifier-Metadaten..."
    # WICHTIG:
    #   - vp_formats ist Pflicht (sonst: vpFormats must not be null)
    #   - jwt_vp mit alg ist Pflicht (sonst: jwtVerifiablePresentation must not be null)
    #   - vc+sd-jwt mit sd-jwt_alg_values und kb-jwt_alg_values
    cat > "${SETUP_DIR}/verifier/config/verifier_metadata.json" <<EOF
{
  "client_id": "${VERIFIER_DID}",
  "client_name": "${CREDENTIAL_NAME_EN} Verifier",
  "client_name#de": "${CREDENTIAL_NAME_DE} Verifier",
  "client_name#fr": "${CREDENTIAL_NAME_FR} Vérificateur",
  "client_name#it": "${CREDENTIAL_NAME_EN} Verificatore",
  "client_name#en": "${CREDENTIAL_NAME_EN} Verifier",
  "logo_uri": "https://${EXTERNAL_DOMAIN}/logo.png",
  "contacts": ["admin@${EXTERNAL_DOMAIN}"],
  "vp_formats": {
    "vc+sd-jwt": {
      "sd-jwt_alg_values": ["ES256"],
      "kb-jwt_alg_values": ["ES256"]
    },
    "jwt_vp": {
      "alg_values": ["ES256"],
      "alg": ["ES256"]
    }
  }
}
EOF
    success "Verifier-Metadaten geschrieben."
}

# ─────────────────────────────────────────────────────────────────────────────
# 6. DOCKER COMPOSE – ISSUER
# ─────────────────────────────────────────────────────────────────────────────
write_issuer_compose() {
    info "Schreibe Issuer docker-compose.yml..."
    cat > "${SETUP_DIR}/issuer/docker-compose.yml" <<EOF
# swiyu Generic Issuer – Docker Compose
# Generiert von swiyu-setup.sh
services:
  issuer-db:
    image: postgres:15-alpine
    container_name: swiyu-issuer-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: issuer
      POSTGRES_PASSWORD: \${ISSUER_DB_PASSWORD}
      POSTGRES_DB: issuerdb
    volumes:
      - issuer-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U issuer -d issuerdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - issuer-internal

  swiyu-issuer-service:
    image: ghcr.io/swiyu-admin-ch/swiyu-issuer:\${ISSUER_IMAGE_TAG:-stable}
    container_name: swiyu-issuer-service
    restart: unless-stopped
    depends_on:
      issuer-db:
        condition: service_healthy
    environment:
      # Datenbank
      POSTGRES_JDBC: jdbc:postgresql://issuer-db:5432/issuerdb
      POSTGRES_USER: issuer
      POSTGRES_PASSWORD: \${ISSUER_DB_PASSWORD}
      # Öffentliche URL
      EXTERNAL_URL: \${ISSUER_EXTERNAL_URL}
      # DID & Schlüssel (offizielle Variablennamen laut swiyu-issuer Doku)
      ISSUER_ID: \${ISSUER_DID}
      DID_SDJWT_VERIFICATION_METHOD: \${ISSUER_DID_VERIFICATION_METHOD}
      SDJWT_KEY: \${ISSUER_SIGNING_KEY}
      STATUS_LIST_KEY: \${STATUS_LIST_SIGNING_KEY}
      DID_STATUS_LIST_VERIFICATION_METHOD: \${STATUS_LIST_VERIFICATION_METHOD}
      # swiyu Status Registry API
      SWIYU_PARTNER_ID: \${SWIYU_PARTNER_ID}
      SWIYU_STATUS_REGISTRY_API_URL: \${SWIYU_STATUS_REGISTRY_API_URL}
      SWIYU_STATUS_REGISTRY_TOKEN_URL: \${SWIYU_STATUS_REGISTRY_TOKEN_URL}
      SWIYU_STATUS_REGISTRY_CUSTOMER_KEY: \${SWIYU_STATUS_REGISTRY_CUSTOMER_KEY}
      SWIYU_STATUS_REGISTRY_CUSTOMER_SECRET: \${SWIYU_STATUS_REGISTRY_CUSTOMER_SECRET}
      SWIYU_STATUS_REGISTRY_AUTH_ENABLE_REFRESH_TOKEN_FLOW: "true"
      SWIYU_STATUS_REGISTRY_BOOTSTRAP_REFRESH_TOKEN: \${SWIYU_STATUS_REGISTRY_BOOTSTRAP_REFRESH_TOKEN}
      # Metadaten – file: Prefix ist zwingend für Filesystem-Pfade!
      METADATA_CONFIG_FILE: file:/config/issuer_metadata.json
      SPRING_PROFILES_ACTIVE: prod
    volumes:
      - ./config/issuer_metadata.json:/config/issuer_metadata.json:ro
    ports:
      - "8080:8080"
    networks:
      - issuer-internal
      - issuer-external

networks:
  issuer-internal:
    internal: true
  issuer-external:

volumes:
  issuer-db-data:
EOF
    success "Issuer docker-compose.yml geschrieben."
}

# ─────────────────────────────────────────────────────────────────────────────
# 7. DOCKER COMPOSE – VERIFIER
# ─────────────────────────────────────────────────────────────────────────────
write_verifier_compose() {
    info "Schreibe Verifier docker-compose.yml..."
    cat > "${SETUP_DIR}/verifier/docker-compose.yml" <<EOF
# swiyu Generic Verifier – Docker Compose
# Generiert von swiyu-setup.sh
services:
  verifier-db:
    image: postgres:15-alpine
    container_name: swiyu-verifier-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: verifier
      POSTGRES_PASSWORD: \${VERIFIER_DB_PASSWORD}
      POSTGRES_DB: verifierdb
    volumes:
      - verifier-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U verifier -d verifierdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - verifier-internal

  swiyu-verifier:
    image: ghcr.io/swiyu-admin-ch/swiyu-verifier:\${VERIFIER_IMAGE_TAG:-stable}
    container_name: swiyu-verifier
    restart: unless-stopped
    depends_on:
      verifier-db:
        condition: service_healthy
    environment:
      # Datenbank
      POSTGRES_JDBC: jdbc:postgresql://verifier-db:5432/verifierdb
      POSTGRES_USER: verifier
      POSTGRES_PASSWORD: \${VERIFIER_DB_PASSWORD}
      # Öffentliche URL
      EXTERNAL_URL: \${VERIFIER_EXTERNAL_URL}
      # DID & Schlüssel
      VERIFIER_DID: \${VERIFIER_DID}
      DID_VERIFICATION_METHOD: \${VERIFIER_DID_VERIFICATION_METHOD}
      SIGNING_KEY: \${VERIFIER_SIGNING_KEY}
      # Metadaten – file: Prefix zwingend!
      OPENID_CLIENT_METADATA_FILE: file:/config/verifier_metadata.json
      SPRING_PROFILES_ACTIVE: prod
    volumes:
      - ./config/verifier_metadata.json:/config/verifier_metadata.json:ro
    ports:
      # OID4VP (öffentlich via Reverse Proxy)
      - "8083:8080"
      # Management API (NUR intern – NICHT öffentlich exponieren!)
      - "127.0.0.1:8084:8081"
    networks:
      - verifier-internal
      - verifier-external

networks:
  verifier-internal:
    internal: true
  verifier-external:

volumes:
  verifier-db-data:
EOF
    success "Verifier docker-compose.yml geschrieben."
}

# ─────────────────────────────────────────────────────────────────────────────
# 8. .ENV-DATEIEN
# ─────────────────────────────────────────────────────────────────────────────
write_env_files() {
    info "Schreibe .env-Dateien..."

    cat > "${SETUP_DIR}/issuer/.env" <<EOF
# swiyu Issuer – Umgebungsvariablen
# ACHTUNG: Geheimnisse – niemals in Git einchecken!
ISSUER_IMAGE_TAG=${ISSUER_IMAGE_TAG}
ISSUER_EXTERNAL_URL=${ISSUER_EXTERNAL_URL}
ISSUER_DID=${ISSUER_DID}
ISSUER_DID_VERIFICATION_METHOD=${ISSUER_DID_VERIFICATION_METHOD}
ISSUER_SIGNING_KEY=${ISSUER_SIGNING_KEY}
STATUS_LIST_SIGNING_KEY=${STATUS_LIST_SIGNING_KEY}
STATUS_LIST_VERIFICATION_METHOD=${STATUS_LIST_VERIFICATION_METHOD}
ISSUER_DB_PASSWORD=${ISSUER_DB_PASSWORD}
SWIYU_PARTNER_ID=${SWIYU_PARTNER_ID}
SWIYU_STATUS_REGISTRY_API_URL=${SWIYU_STATUS_REGISTRY_API_URL}
SWIYU_STATUS_REGISTRY_TOKEN_URL=${SWIYU_STATUS_REGISTRY_TOKEN_URL}
SWIYU_STATUS_REGISTRY_CUSTOMER_KEY=${SWIYU_STATUS_REGISTRY_CUSTOMER_KEY}
SWIYU_STATUS_REGISTRY_CUSTOMER_SECRET=${SWIYU_STATUS_REGISTRY_CUSTOMER_SECRET}
SWIYU_STATUS_REGISTRY_BOOTSTRAP_REFRESH_TOKEN=${SWIYU_STATUS_REGISTRY_BOOTSTRAP_REFRESH_TOKEN}
EOF
    chmod 600 "${SETUP_DIR}/issuer/.env"

    cat > "${SETUP_DIR}/verifier/.env" <<EOF
# swiyu Verifier – Umgebungsvariablen
# ACHTUNG: Geheimnisse – niemals in Git einchecken!
VERIFIER_IMAGE_TAG=${VERIFIER_IMAGE_TAG}
VERIFIER_EXTERNAL_URL=${VERIFIER_EXTERNAL_URL}
VERIFIER_DID=${VERIFIER_DID}
VERIFIER_DID_VERIFICATION_METHOD=${VERIFIER_DID_VERIFICATION_METHOD}
VERIFIER_SIGNING_KEY=${VERIFIER_SIGNING_KEY}
VERIFIER_DB_PASSWORD=${VERIFIER_DB_PASSWORD}
EOF
    chmod 600 "${SETUP_DIR}/verifier/.env"
    success ".env-Dateien geschrieben (chmod 600)."
}

# ─────────────────────────────────────────────────────────────────────────────
# 9. APACHE REVERSE PROXY
# ─────────────────────────────────────────────────────────────────────────────
configure_apache() {
    info "Konfiguriere Apache Reverse Proxy für ${EXTERNAL_DOMAIN}..."
    cat > "/etc/apache2/sites-available/swiyu.conf" <<EOF
<VirtualHost *:80>
    ServerName ${EXTERNAL_DOMAIN}

    # Issuer OID4VCI (öffentlich)
    ProxyPreserveHost On
    ProxyPass        /issuer/   http://localhost:8080/
    ProxyPassReverse /issuer/   http://localhost:8080/
    # Verifier OID4VP (öffentlich)
    ProxyPass        /verifier/ http://localhost:8083/
    ProxyPassReverse /verifier/ http://localhost:8083/

    # Verifier Management Port 8084 ist NICHT proxied – nur intern erreichbar

    ErrorLog  \${APACHE_LOG_DIR}/swiyu-error.log
    CustomLog \${APACHE_LOG_DIR}/swiyu-access.log combined
</VirtualHost>
EOF
    a2ensite swiyu.conf -q
    apache2ctl configtest
    systemctl reload apache2
    success "Apache HTTP konfiguriert."

    # TLS via certbot
    if certbot --apache -d "${EXTERNAL_DOMAIN}" --non-interactive --agree-tos \
        --email "admin@${EXTERNAL_DOMAIN}" --redirect 2>/dev/null; then
        success "TLS-Zertifikat erstellt."
        # ProxyPass in SSL-Config eintragen falls noch nicht vorhanden
        local ssl_conf
        ssl_conf=$(find /etc/apache2/sites-available -name "*le-ssl*" 2>/dev/null | head -1)
        if [[ -n "${ssl_conf}" ]] && ! grep -q "ProxyPass" "${ssl_conf}"; then
            sed -i "s|</VirtualHost>|    ProxyPreserveHost On\n    ProxyPass        /issuer/   http://localhost:8080/\n    ProxyPassReverse /issuer/   http://localhost:8080/\n    ProxyPass        /verifier/ http://localhost:8083/\n    ProxyPassReverse /verifier/ http://localhost:8083/\n\n</VirtualHost>|" "${ssl_conf}"
            systemctl reload apache2
            success "Proxy-Einträge in SSL-Konfiguration eingefügt."
        fi
    else
        warn "certbot fehlgeschlagen – manuell ausführen:"
        warn "  sudo certbot --apache -d ${EXTERNAL_DOMAIN}"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# 10. SYSTEMD-SERVICES
# ─────────────────────────────────────────────────────────────────────────────
write_systemd_units() {
    info "Schreibe systemd-Units..."

    for svc in issuer verifier; do
        local dir="${SETUP_DIR}/${svc}"
        cat > "/etc/systemd/system/swiyu-${svc}.service" <<EOF
[Unit]
Description=swiyu Generic ${svc^}
Requires=docker.service
After=docker.service network-online.target

[Service]
Type=simple
WorkingDirectory=${dir}
EnvironmentFile=${dir}/.env
ExecStart=/usr/bin/docker compose up --remove-orphans
ExecStop=/usr/bin/docker compose down
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
    done

    systemctl daemon-reload
    success "systemd-Units registriert: swiyu-issuer.service, swiyu-verifier.service"
}

# ─────────────────────────────────────────────────────────────────────────────
# 11. SERVICES STARTEN
# ─────────────────────────────────────────────────────────────────────────────
start_services() {
    info "Starte swiyu-Dienste..."

    for svc in issuer verifier; do
        info "  → swiyu-${svc}..."
        systemctl enable --now "swiyu-${svc}.service"
    done

    info "Warte 30 Sekunden auf Initialisierung..."
    sleep 30

    local issuer_ok=false verifier_ok=false
    curl -sf "http://localhost:8080/actuator/health" | grep -q '"status":"UP"' && issuer_ok=true
    curl -sf "http://localhost:8083/actuator/health" | grep -q '"status":"UP"' && verifier_ok=true

    $issuer_ok  && success "Issuer Service läuft."  || warn "Issuer Service noch nicht bereit – Logs prüfen: sudo docker logs swiyu-issuer-service"
    $verifier_ok && success "Verifier Service läuft." || warn "Verifier Service noch nicht bereit – Logs prüfen: sudo docker logs swiyu-verifier"
}

# ─────────────────────────────────────────────────────────────────────────────
# 12. STATUS-LISTE INITIALISIEREN
# ─────────────────────────────────────────────────────────────────────────────
init_status_list() {
    info "Initialisiere Issuer-Statusliste..."

    # Warte bis Service vollständig gestartet ist
    local max_wait=60
    local waited=0
    until curl -sf "http://localhost:8080/actuator/health" | grep -q '"status":"UP"'; do
        sleep 3
        waited=$((waited + 3))
        if [[ ${waited} -ge ${max_wait} ]]; then
            warn "Service nicht bereit – Statusliste manuell erstellen!"
            return
        fi
    done

    local response
    response=$(curl -sf -X POST "http://localhost:8080/management/api/status-list" \
        -H "Content-Type: application/json" \
        -d '{"type":"TOKEN_STATUS_LIST","maxLength":100000,"config":{"bits":2}}' \
        || true)

    if [[ -n "${response}" ]]; then
        local status_url
        status_url=$(echo "${response}" | jq -r '.statusRegistryUrl // empty')
        if [[ -n "${status_url}" ]]; then
            success "Statusliste erstellt!"
            echo ""
            warn "▶ statusRegistryUrl für Credential-Ausstellung:"
            echo "    ${status_url}"
            echo ""
            # In Datei speichern für spätere Verwendung
            echo "${status_url}" > "${SETUP_DIR}/issuer/status_registry_url.txt"
            chmod 640 "${SETUP_DIR}/issuer/status_registry_url.txt"
            success "URL gespeichert in: ${SETUP_DIR}/issuer/status_registry_url.txt"
        else
            warn "Unerwartete Antwort:"
            echo "${response}" | jq .
        fi
    else
        warn "Statusliste konnte nicht automatisch erstellt werden."
        warn "Manuell nach erfolgtem Start ausführen:"
        warn "  curl -X POST http://localhost:8080/management/api/status-list \\"
        warn "       -H 'Content-Type: application/json' \\"
        warn "       -d '{\"type\":\"TOKEN_STATUS_LIST\",\"maxLength\":100000,\"config\":{\"bits\":2}}'"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# 13. SAMPLE VERIFICATION REQUEST
# ─────────────────────────────────────────────────────────────────────────────
write_sample_verification_request() {
    cat > "${SETUP_DIR}/verifier/config/sample_verification_request.json" <<EOF
{
  "accepted_issuer_dids": ["${ISSUER_DID}"],
  "response_mode": "direct_post",
  "presentation_definition": {
    "id": "00000000-0000-0000-0000-000000000000",
    "input_descriptors": [
      {
        "id": "11111111-1111-1111-1111-111111111111",
        "format": {
          "vc+sd-jwt": {
            "sd-jwt_alg_values": ["ES256"],
            "kb-jwt_alg_values": ["ES256"]
          }
        },
        "constraints": {
          "fields": [
            {
              "path": ["\$.vct"],
              "filter": {
                "type": "string",
                "const": "${CREDENTIAL_VCT}"
              }
            },
            {
              "path": ["\$.firstName"]
            },
            {
              "path": ["\$.lastName"]
            }
          ]
        }
      }
    ]
  }
}
EOF
    success "Sample Verification Request geschrieben."
}

# ─────────────────────────────────────────────────────────────────────────────
# 14. ABSCHLUSS-ZUSAMMENFASSUNG
# ─────────────────────────────────────────────────────────────────────────────
print_summary() {
    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  swiyu Setup abgeschlossen!${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  ${CYAN}Apache Reverse Proxy${NC}"
    echo    "    https://${EXTERNAL_DOMAIN}/issuer   → Issuer OID4VCI"
    echo    "    https://${EXTERNAL_DOMAIN}/verifier → Verifier OID4VP"
    echo    "    TLS:  /etc/letsencrypt/live/${EXTERNAL_DOMAIN}/"
    echo    "    Logs: /var/log/apache2/swiyu-access.log"
    echo ""
    echo -e "  ${CYAN}Issuer Service${NC}"
    echo    "    Intern:     http://localhost:8080"
    echo    "    Management: http://localhost:8080/management/api/"
    echo    "    Swagger:    http://localhost:8080/swagger-ui/index.html"
    echo    "    Extern:     ${ISSUER_EXTERNAL_URL}"
    echo ""
    echo -e "  ${CYAN}Verifier Service${NC}"
    echo    "    OID4VP:     http://localhost:8083"
    echo    "    Management: http://localhost:8084/management/api/  (nur intern!)"
    echo    "    Swagger:    http://localhost:8083/swagger-ui/index.html"
    echo    "    Extern:     ${VERIFIER_EXTERNAL_URL}"
    echo ""
    echo -e "  ${CYAN}Naechste Schritte${NC}"
    echo    "  -------------------------------------------------------------"
    echo -e "  ${RED}0. Trust Registry - PFLICHT fuer Wallet-Akzeptanz!${NC}"
    echo    "     Ohne Trust Statement zeigt die Wallet: Ungueltiger Nachweis"
    echo    "     a) swiyucorebusiness_trust im API Self-Service Portal abonnieren"
    echo    "        (Zugang beantragen: swiyu@eid.admin.ch)"
    echo    "     b) Status pruefen (kein Token noetig):"
    echo    "        curl -s https://trust-reg.trust-infra.swiyu-int.admin.ch/api/v1/truststatements/identity/${ISSUER_DID}"
    echo    "        [] = kein Trust Statement, [...] = OK"
    echo    "     c) Trust Statement erstellen (Authoring API):"
    echo    ""
    echo    "  1. Erstes Credential ausstellen:"
    local status_url=""
    [[ -f "${SETUP_DIR}/issuer/status_registry_url.txt" ]] && \
        status_url=$(cat "${SETUP_DIR}/issuer/status_registry_url.txt")
    echo    "     curl -X POST http://localhost:8080/management/api/credentials \\"
    echo    "       -H 'Content-Type: application/json' \\"
    echo    "       -d '{"
    echo    "         \"metadata_credential_supported_id\": [\"${CREDENTIAL_TYPE}\"],"
    echo    "         \"credential_subject_data\": {\"firstName\": \"Hans\", \"lastName\": \"Muster\", \"gln\": \"7601000000000\"},"
    echo    "         \"offer_validity_seconds\": 86400,"
    echo    "         \"credential_valid_until\": \"2030-01-01T00:00:00Z\","
    echo    "         \"credential_valid_from\": \"2026-01-01T00:00:00Z\","
    echo    "         \"status_lists\": [\"${status_url}\"]"
    echo    "       }'"
    echo    ""
    echo    "  2. QR-Code für Wallet-Scan generieren (aus offer_deeplink):"
    echo    "     echo '<offer_deeplink>' | qrencode -t ANSIUTF8"
    echo    ""
    echo    "  3. Verifikation erstellen:"
    echo    "     curl -X POST http://localhost:8084/management/api/verifications \\"
    echo    "          -H 'Content-Type: application/json' \\"
    echo    "          -d @${SETUP_DIR}/verifier/config/sample_verification_request.json"
    echo    ""
    echo -e "  ${YELLOW}Logs anzeigen:${NC}"
    echo    "    sudo docker logs swiyu-issuer-service -f"
    echo    "    sudo docker logs swiyu-verifier -f"
    echo    "    journalctl -fu swiyu-issuer"
    echo    "    journalctl -fu swiyu-verifier"
    echo    ""
    echo -e "  ${YELLOW}WICHTIG – Refresh Token:${NC}"
    echo    "    Der Bootstrap Refresh Token ist EINMALIG verwendbar!"
    echo    "    Der Service speichert nach dem ersten Start einen neuen Token in der DB."
    echo    "    Falls der Service abstürzt oder die DB gelöscht wird:"
    echo    "      1. Im API Self-Service Portal neuen Token generieren"
    echo    "      2. sudo vim ${SETUP_DIR}/issuer/.env  (Token ersetzen)"
    echo    "      3. sudo docker compose -f ${SETUP_DIR}/issuer/docker-compose.yml \\"
    echo    "              --env-file ${SETUP_DIR}/issuer/.env down -v"
    echo    "         sudo docker compose -f ${SETUP_DIR}/issuer/docker-compose.yml \\"
    echo    "              --env-file ${SETUP_DIR}/issuer/.env up -d"
    echo    ""
    echo -e "  ${YELLOW}WICHTIG – Token URL:${NC}"
    echo    "    SWIYU_STATUS_REGISTRY_TOKEN_URL muss den vollen Pfad enthalten:"
    echo    "    https://keymanager-prd.api.admin.ch/keycloak/realms/APIGW/protocol/openid-connect/token"
    echo    ""
    echo -e "  ${YELLOW}WICHTIG – Status Registry API URL:${NC}"
    echo    "    SWIYU_STATUS_REGISTRY_API_URL = https://status-reg-api.trust-infra.swiyu-int.admin.ch"
    echo    "    (nicht status-reg, sondern status-reg-api)"
    echo    ""
    echo -e "  ${YELLOW}Konfigurationsverzeichnis:${NC} ${SETUP_DIR}"
    echo ""
}

# ─────────────────────────────────────────────────────────────────────────────
# MAIN
# ─────────────────────────────────────────────────────────────────────────────
main() {
    if [[ "${EUID}" -ne 0 ]]; then
        error "Dieses Script muss als root ausgeführt werden. Nutze: sudo $0"
    fi

    echo -e "${CYAN}"
    echo "  ███████╗██╗    ██╗██╗██╗   ██╗██╗   ██╗"
    echo "  ██╔════╝██║    ██║██║╚██╗ ██╔╝██║   ██║"
    echo "  ███████╗██║ █╗ ██║██║ ╚████╔╝ ██║   ██║"
    echo "  ╚════██║██║███╗██║██║  ╚██╔╝  ██║   ██║"
    echo "  ███████║╚███╔███╔╝██║   ██║   ╚██████╔╝"
    echo "  ╚══════╝ ╚══╝╚══╝ ╚═╝   ╚═╝    ╚═════╝ "
    echo "  Generic Issuer & Verifier – Debian Setup v2.0"
    echo -e "${NC}"

    install_dependencies
    create_directories
    write_issuer_metadata
    write_verifier_metadata
    write_issuer_compose
    write_verifier_compose
    write_env_files
    write_sample_verification_request
    write_systemd_units
    start_services
    configure_apache
    init_status_list
    print_summary
}

main "$@"
